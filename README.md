# ☁ NINE Cloud
![main_image](https://github.com/Lee-chan0/nomyproject/assets/147553654/7d067198-cbd1-4824-abca-4de724fd2d07)
## ✍🏻 서비스 소개
NINE Cloud는 매일 하나의 일기를 작성하며 자신의 감정을 되돌아보고 AI 솔루션을 받는 감정일기 서비스입니다.
## 
## 🌞프로젝트 소개
<strong>[Front-End]</strong> : CRUD, AI접목, Socket을 이용한 채팅기능, 무한스크롤, canvas사용, OAuth구현

<strong>[Back-End]</strong> : CRUD, OAuth로그인, Socket을 활용한 채팅기능, S3를 활용한 이미지 업로드, 자동화배포 CI/CD에 Docker, Nginx를 추가해 무중단배포 파이프라인 구축


<strong>[USER]</strong> : 바쁘게 살아가는 현대인들을 위해, 자신의 하루 감정을 날씨와 연관 지어 돌아볼 수 있는 다이어리
##

## 📂 Project GitHub
<strong>[Front-End]</strong> : https://github.com/final-project-hh99/front.git<br>
<strong>[Back-End]</strong> : https://github.com/Lee-chan0/final_project_back
## 

## ⛅️ 팀원 소개 (👨‍👩‍👧‍👦구르미들)

- **Back End**
  - 유재현(부리더)([https://github.com/yjhorion](https://github.com/yjhorion))
    1. Main달력
    2. feed생성
    3. multer-S3 이미지 업로드
    4. socket.io 채팅기능
  - 이찬영([https://github.com/Lee-chan0](https://github.com/Lee-chan0))
    1. SignIn, SignUp
    2. OAuth
    3. CI/CD, 인프라
    4. DevOps
- **Front End**
  - 주철민(리더)([https://github.com/cheolminJOO](https://github.com/cheolminJOO))
    1. Main달력
    2. 상세페이지
    3. 마이페이지
  - 송지우([https://github.com/nsong113](https://github.com/nsong113))
    1. post페이지
    2. GPT(AI)
    3. Community페이지
  - 한덕용([https://github.com/HyperQuanx](https://github.com/HyperQuanx))
    1. OAuth
    2. Sign In/Up
    3. WebSocket
- **Designer**
  - 이승연([20211009@sungshin.ac.kr](20211009@sungshin.ac.kr))

## ❄️ Project Architecture

![Untitled Diagram drawio (3)](https://github.com/Lee-chan0/nomyproject/assets/147553654/40f530a0-16cd-4abd-9c66-c57508d5c5d4)


## Stacks

<div align="center">
  <h1>🛠 Tech Stack</h1>
  <p>
    <img src="https://img.shields.io/badge/javascript-F0DB4F?style=for-the-badge&logo=javascript&logoColor=black">
    <img src="https://img.shields.io/badge/node.js-68A063?style=for-the-badge&logo=Node.js&logoColor=white">
    <img src="https://img.shields.io/badge/express-FF6C37?style=for-the-badge&logo=express&logoColor=white">
  </p>
</div>

<div align="center">
  <h1>🗄️ DB / ORM</h1>
  <p>
    <img src="https://img.shields.io/badge/mysql-00758F?style=for-the-badge&logo=mysql&logoColor=white">
    <img src="https://img.shields.io/badge/mongoDB-12924F?style=for-the-badge&logo=MongoDB&logoColor=white">
    <img src="https://img.shields.io/badge/AWS%20RDS-527FFF?style=for-the-badge&logo=amazonrds&logoColor=white">
    <img src="https://img.shields.io/badge/Redis-C92B2B?style=for-the-badge&logo=redis&logoColor=white">
    <img src="https://img.shields.io/badge/Prisma-2A7AE4?style=for-the-badge&logo=Prisma&logoColor=white">
  </p>
</div>

<div align="center">
  <h1>🖥️ CI/CD & DevOps</h1>
  <p>
    <img src="https://img.shields.io/badge/github-6E5494?style=for-the-badge&logo=github&logoColor=white">
    <img src="https://img.shields.io/badge/GitHub%20Actions-2088FF?style=for-the-badge&logo=githubactions&logoColor=white">
    <img src="https://img.shields.io/badge/AWS%20EC2-FF9900?style=for-the-badge&logo=amazonec2&logoColor=white">
    <img src="https://img.shields.io/badge/AWS%20S3-569A31?style=for-the-badge&logo=amazons3&logoColor=white">
    <img src="https://img.shields.io/badge/AWS%20CodeDeploy-FF7F00?style=for-the-badge&logo=aws&logoColor=white">
    <img src="https://img.shields.io/badge/Docker%20Compose-DA70D6?style=for-the-badge&logo=docker&logoColor=white">
    <img src="https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white">
    <img src="https://img.shields.io/badge/Nginx-009639?style=for-the-badge&logo=nginx&logoColor=white">
  </p>
</div>

<div align="center">
  <h1>📜 Library & Monitoring & Communication</h1>
  <p>
    <img src="https://img.shields.io/badge/socket.io-FF4081?style=for-the-badge&logo=socket.io&logoColor=white">
    <img src="https://img.shields.io/badge/JWT-00B2A9?style=for-the-badge&logo=jsonwebtokens&logoColor=white">
    <img src="https://img.shields.io/badge/Swagger-E3E569?style=for-the-badge&logo=swagger&logoColor=white">
    <img src="https://img.shields.io/badge/Grafana-F46800?style=for-the-badge&logo=grafana&logoColor=white">
    <img src="https://img.shields.io/badge/Jest-C21325?style=for-the-badge&logo=jest&logoColor=white">
    <img src="https://img.shields.io/badge/Notion-8B8B8B?style=for-the-badge&logo=notion&logoColor=white">
    <img src="https://img.shields.io/badge/Slack-E01E5A?style=for-the-badge&logo=slack&logoColor=white">
  </p>
  <br>
</div>

## 📜 Library

|      Library       |                                 Description                                  |
|:------------------:|:----------------------------------------------------------------------------:|
|      dotenv       |        환경 변수를 관리하여 보안적으로 민감한 데이터를 안전하게 숨김         |
|       cors        |           웹 애플리케이션의 Cross-Origin Resource Sharing 해결               |
|      bcrypt       |          비밀번호와 같은 데이터를 안전하게 해시하여 저장하기 위함           |
|        joi        |                      요청 데이터의 유효성 검증을 위함                        |
|    nodemailer     |           이메일 전송 기능을 위한 Node.js 기반의 메일 전송 라이브러리          |
|      express      |      빠르고 유연한 웹 애플리케이션 개발을 위한 Node.js 웹 프레임워크        |
|   jsonwebtoken    |        사용자 인증과 정보 전송을 위한 JSON 기반의 Web Token 생성            |
|     date-fns      |          날짜와 시간을 다루기 위한 포괄적이고 신뢰성 있는 라이브러리         |
|   date-fns-tz     |               시간대를 고려한 날짜 및 시간 처리를 위한 라이브러리             |
|     ioredis       |         Node.js에서 Redis 데이터베이스와 통신하기 위한 효율적인 라이브러리     |
|      multer       |               파일 업로드를 처리하기 위한 Node.js 미들웨어                  |
|    socket.io      |             실시간, 양방향 통신을 위한 Node.js 기반의 라이브러리            |
|     node-cron     |        정해진 일정에 따라 작업을 실행하기 위한 Node.js 기반 스케줄러         |
|     multer-s3     |             AWS S3와 통합하여 파일 업로드를 처리하는 라이브러리              |


## 🔎 API

[Notion API Address](https://www.notion.so/API-22f9456b7c254576b2a9cbc101c603d1)

![캡처2](https://github.com/Lee-chan0/nomyproject/assets/147553654/b42a681c-1e56-4a08-94de-b601727e39a3)
![캡처3](https://github.com/Lee-chan0/nomyproject/assets/147553654/980c3de8-3e8f-46b9-bd2c-2e5a0aedf415)
![캡처4](https://github.com/Lee-chan0/nomyproject/assets/147553654/3ff9b052-0a8b-401c-b714-823ab3920227)

## 📋 ERD

![drawSQL-finalproject-export-2023-12-21](https://github.com/Lee-chan0/nomyproject/assets/147553654/882e770c-f5b9-4b0b-8053-a73578bc256d)

## 💣 트러블슈팅
<details>
<summary>multerS3를 사용한 이미지 업로드</summary>
❗ 문제 상황 : multerS3로 bucket에 Image uploadthis.client.send is not a function 에러가 발생<br>
❗ 기존 설정의 문제점<br>
  - 코드상의 문제를 의심했으나, 코드상엔 문제가 없는것을 확인했습니다.<br>
  - 이후 multer-s3와 aws-sdk모듈이 서로 호환되는 버전이어야 한다는것을 알게됐습니다.
✅ 버전 업데이트
  - npm을 사용하여, 서로 호환되는 버전으로 업데이트해줌으로써 해결했습니다.
  
```javascript
// package.json
...
"aws-sdk" : "^2.1520.0",
"multer-s3" : "^3.0.1",
...
```
</details>

<details>
<summary>socket.io와 mongoDB 연결 이슈</summary>
❗ 문제상황 : socket을 기존 DB가 아닌, mongoDB에 따로 연결하여 사용하려 할때, timeout에러가 발생하면서 채팅이 연결되지않은 현상발생<br>
❗ 문제 해결 접근<br>
- local환경에서 .env의 값과 mongoDB자체의 connection에러가 없는것을 확인했습니다. <br>
- app.js(서버 실행 파일)에서 mongoDB가 연결되기 이전에 router에서 접근이 이루어지는지도 확인했으나 문제가 없었습니다. <br>
- GitActions에는 정상적으로 secrets변수가 .env파일에 할당되는것을 확인했지만, 자동화 배포도중 docker-compose를 사용한 빌드과정에서 .env파일이 업데이트 되지 않았습니다. <br>
- 배포가 되는 ec2서버에 .env파일을 확인해보니, 정상적으로 .env파일에 mongoDB 연결에 필요한 변수가 업데이트되지 않는것을 확인했습니다.<br>
  
✅ 문제해결<br>
- docker-compose를 통해 빌드되는 과정에서 string으로 이루어진 환경변수는 “”로 감싸주지 않으면 .env파일에 업데이트되지 않는것을 확인했고, 문자열 처리를 해주자 정상적으로 .env파일에 업데이트 되었습니다.


</details>

<details>
<summary>EC2 인스턴스 환경에서의 Docker권한 이슈</summary>
❗문제 상황 : docker를 사용했을때, connect: permission denied 가 생겨 docker 사용 불가<br>
✅ 문제 해결 접근<br>
1. 에러원인 분석 : 해당 error message를 구글링하여 비슷한 사례를 찾아보니, docker가 group에 속해있지 않기때문임을 알게됐습니다.<br>
2. 해결 방법 : docker gruop이 추가되지 않았고, 해당 group에 로그인 중인 유저가 추가되어 있지 않았기 때문이라는것을 알게되어, <br>
  
```javascript
//ec2 인스턴스 환경(ubuntu)
sudo groupadd docker
sudo usermod -aG docker $USER
```
이후, exit명령어 혹은 newgrp docker 명령어로 적용해주었습니다.<br>
</details>

<details>
<summary>Blue/Green전략 무중단 배포 중 다운타임 이슈</summary>
❗ 문제 상황 : ‘무중단 배포’이지만, 서버가 항상 잠깐 꺼졌다가 켜져서 ‘다운타임’이 발생하여, 무중단 배포 전략에 치명적인 에러였습니다. (502 Bad Gateway)<br>
✅ 원인 파악 및 해결 방법 : 서버의 (Nginx)502 Bad Gateway 발생<br>
1. 헬스체크 엔드포인트 구현

```javascript
// health체크 엔드포인트
app.get("/health", (req, res) => {
  const isServerOnline = true;

  const serverStartTime = new Date().toISOString();

  const cpuUsage = os.loadavg()[0]; 
  const totalMemory = os.totalmem();
  const freeMemory = os.freemem();
  const usedMemory = totalMemory - freeMemory;

  const diskInfo = os.cpus(); 
  

  const healthStatus = {
    serverStatus: isServerOnline ? "Online" : "Offline",
    serverStartTime: serverStartTime,
    cpuUsage: cpuUsage,
    memoryUsage: {
      total: totalMemory,
      used: usedMemory,
      free: freeMemory,
    },
    diskSpace: diskInfo,
  };
  if (isServerOnline) {
    res.status(200).json(healthStatus);
  } else {
    res.status(503).json({ serverStatus: "Offline" });
  }
});
```
해당 엔드포인트로 서버가 Online인지, Offline인지 체크가 가능합니다. <br>

2. docker-compose.yml파일에 자동화 헬스체크 코드 추가<br>

```javascript
  blue:
    build: .
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "https://astraiosissda.shop/health"]
      interval: 30s
      timeout: 10s
      retries: 5
```
30초에 한번씩 서버의 해당 엔드포인트에 요청을 보내어 헬스체크를 진행하고, 5번의 재시도를 합니다.<br>

3. docker실행파일인, ./deploy파일 수정<br>

```javascript
#!/bin/bash

CURRENT=$(docker ps --format '{{.Names}}' | grep -oE 'finalcicd_(blue|green)_1' | head -n 1 | cut -d'_' -f2)

echo "Current container: $CURRENT"

if [ "$CURRENT" == "blue" ]; then
    docker-compose up -d --build green

    echo "Green Container 헬스 체크"
    HEALTH_CHECK() {
        local retries=0
        until [ $retries -ge 3 ]; do
            if curl --connect-timeout 3 --max-time 3 -f https://astraiosissda.shop/health; then
                echo "Green Container 헬스 체크 성공 / 트래픽 전환"
                return 0
            else
                retries=$((retries+1))
                echo "헬스 체크 실패 5초뒤 다시 시도"
                sleep 5
            fi
        done
        echo "헬스 체크 실패 기존 컨테이너로 롤백"
        docker-compose stop green
        exit 1
    }

    HEALTH_CHECK

    sed -i 's/blue:3000/green:3000/' ./nginx.conf
    docker-compose restart nginx


    docker-compose stop blue

elif [ "$CURRENT" == "green" ]; then
    docker-compose up -d --build blue

    echo "Blue Container 헬스 체크"
    HEALTH_CHECK() {
        local retries=0
        until [ $retries -ge 3 ]; do
            if curl --connect-timeout 3 --max-time 3 -f https://astraiosissda.shop/health; then
                echo "Blue Container 헬스 체크 성공 / 트래픽 전환"
                return 0
            else
                retries=$((retries+1))
                echo "헬스 체크 실패 5초뒤 다시 시도"
                sleep 5
            fi
        done
        echo "헬스 체크 실패 기존 컨테이너로 롤백"
        docker-compose stop blue
        exit 1
    }

    HEALTH_CHECK

    sed -i 's/green:3000/blue:3000/' ./nginx.conf
    docker-compose restart nginx

    docker-compose stop green
fi
```
해당 파일로, 현재 실행중인 컨테이너를 확인하고, 새롭게 빌드한 컨테이너의 헬스체크를 진행한뒤, 헬스체크에 실패했다면, 기존 컨테이너로 롤백,<br> 헬스체크에 성공했다면, nginx를 활용해 트래픽을 전환하며, 새로운 컨테이너를 up하고 기존 컨테이너를 down시킵니다.<br>
✅ 결과 : 이후, 서버가 끊김없이 버전에 따라 배포가 잘 진행되었고, 다운타임현상을 해결할 수 있었습니다.
</details>
